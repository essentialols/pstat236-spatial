---
title: "Areal Data Group Project"
author: "Kayla, Ingmar, Hanmo, Will"
date: "`r Sys.Date()`"
output: 
  html_document:
    keep_md: true
    toc: true
    toc_float: true
    toc_depth: 3
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE)
```

# Set up

**resources we are referencing:  

- http://www.css.cornell.edu/faculty/dgr2/_static/files/ov/ov_ADSA_Handout.pdf  
- Banerjee, Carlin and Gelfand, Hierarchical Modeling and Analysis for Spatial Data, 1st Edition, Ch 3  
- Bivand et al 2013 Ch 9  
- rspatial.org  

The packages we used are:  
```{r}
# install.packages(c("sp", "raster", "spdep", ....))
library(tidyverse)
library(sp)
# library(spData)
# library(raster) # or terra
library(terra)
library(spdep)
## more...
```

The dataset we are using is published in `spData` and comes from: _Anselin, Luc. 1988. Spatial econometrics: methods and models. Dordrecht: Kluwer Academic, Table 12.1 p. 189._
```{r}
## load dataset(s)
columbus <- vect(system.file("shapes/columbus.shp", package="spData")[1])
df.columbus <- as.data.frame(columbus)
glimpse(df.columbus)
```

The county data is:  

* HOVAL housing value (in \$1,000)  
* INC household income (in \$1,000)  
* CRIME residential burglaries and vehicle thefts per thousand households in the neighborhood  
* OPEN open space in neighborhood  
* PLUMB percentage housing units without plumbing  

Look at some summaries of those metrics: _Kayla_   
```{r, echo=FALSE, out.width= "50%"}
## set up plotting color palette
pal = colorRampPalette(c("lightgrey", "darkblue"))(10)

cc <- cut(columbus$HOVAL, 10)
mycols <- pal[as.numeric(cc)]
hist(df.columbus$HOVAL, 
     main = "Housing value", 
     xlab = "Value  in $1000")
plot(columbus, col = mycols, main = "Housing value in $1000")

cc <- cut(columbus$INC, 10)
mycols <- pal[as.numeric(cc)]
hist(df.columbus$INC, 
     main = "Household income", 
     xlab = "Value  in $1000")
plot(columbus, col = mycols, main = "Household income in $1000") 

cc <- cut(columbus$CRIME, 10)
mycols <- pal[as.numeric(cc)]
hist(df.columbus$CRIME,
     main = "Residential burglaries and vehicle thefts", 
     xlab = "CRIME per thousand households in the neighborhood")
plot(columbus, col = mycols, main = "Residential burglaries and vehicle thefts") 

cc <- cut(columbus$OPEN, 10)
mycols <- pal[as.numeric(cc)]
hist(df.columbus$OPEN, 
     main = "Open space in neighborhood", 
     xlab = "open space")
plot(columbus, col = mycols, main = "Open space in neighborhood") 

cc <- cut(columbus$PLUMB, 10)
mycols <- pal[as.numeric(cc)]
hist(df.columbus$PLUMB, 
     main = "Percentage of housing units without plumbing", 
     xlab = "Percent no plumbing")
plot(columbus, col = mycols, main = "Percentage of housing units without plumbing") 
```


# Exploratory Data Analysis  

## Measures of spatial association  

### Neighbors _Kayla_  
adjecency matrix construction - nearest neighbors, categories, 1/dist  
Figures out what the neighbors are:  
```{r}
xy <- centroids(columbus)
head(neighbors <- adjacent(columbus, symmetrical=TRUE))
plot(columbus, col='lightgray', border='black', lwd=1)
p1 <- xy[neighbors[,1], ]
p2 <- xy[neighbors[,2], ]
lines(p1, p2, col='red', lwd=2)
```

As an adjecency matrix  
```{r}
head(neighbors <- adjacent(columbus, pairs = FALSE))
```

### Moran's I - _Kayla_  
Using `spdep` __...might add the formula for Moran's I here__  

#### House value  
```{r, out.width= "50%"}
## Moran's I
ww <-  adjacent(columbus, "touches", pairs=FALSE)
(ac <- autocor(columbus$HOVAL, ww, "moran"))
## Monte Carlo sim to test for significance (I'm following https://rspatial.org/terra/analysis/3-spauto.html#compute-morans-i)
m <- sapply(1:99, function(i) {
    autocor(sample(columbus$HOVAL), ww, "moran")
})
hist(m)

## p-value
sum(m >= ac) / 100
```
So there is some (Moran's I range (-1 to 1) = `r ac`) spatial autocorrelation in house value by county in Columbus Ohio.

#### Household income  
```{r, out.width= "50%"}
## Moran's I
(ac <- autocor(columbus$INC, ww, "moran"))
## Monte Carlo sim to test for significance (I'm following https://rspatial.org/terra/analysis/3-spauto.html#compute-morans-i)
m <- sapply(1:99, function(i) {
    autocor(sample(columbus$INC), ww, "moran")
})
hist(m)

## p-value
sum(m >= ac) / 100
```
There is also positive (Moran's I = `r ac`) Spatial autocorrelation in household income.   

#### Keep going?

### Geary's C  __Ingmar__

$$
C=\frac{(n-1) \sum_{i} \sum_{j} w_{i j}\left(Y_{i}-Y_{j}\right)^{2}}{2\left(\sum_{i \neq j} w_{i j}\right) \sum_{i}\left(Y_{i}-\bar{Y}\right)^{2}}
$$

Reinhard Furrer (http://user.math.uzh.ch/furrer/download/sta330/script_sta330.pdf, Version May 26, 2021) suggests to take 1-C to compare it to Moran's I more easily.

```{r}
(gearyc <- autocor(columbus$HOVAL, ww, "geary"))
1-gearyc
```


## Spatial smoothers  
Could delve further into this for the final project eg smoothing in image classification of fragmented habitats is problematic.  

### Clustering  

### Markov random fields  

# Spatial regression models  

## Zero means __Ingmar__

## Simultaneous Autoregressive Models  __Ingmar__

### SAR error model

```{r}
#Create a k=5 nearest neighbor set

# us.nb5<-knearneigh(geom(columbus), k=5, use_kd_tree = T)
# us.nb5<-knn2nb(us.nb5)
# us.wt5<-nb2listw(make.sym.nb(us.nb5), style="W")
# 
# spdep::errorsarlm(HOVAL~INC+CRIME+OPEN+PLUMB, columbus, listw = ww, etype="error", method="spam")

# fit.err<-errorsarlm(mortz~rurz+blacz+hisz+unemz+hvalz+densz+giniz, spdat, listw=us.wt5, etype="error", method="spam")

#  (formula = Z ~ PEXPOSURE + PCTAGE65P + PCTOWNHOME,
# data = NY8, listw = NY8listwB)
```


### SAR lag model  

### SAR Durbin model  

### Likelihood Ratio  

### Model comparisons  

## Conditional Autoregressive Models  

### Gaussian case  

### non-Gaussian case  

### Model comparisons  

